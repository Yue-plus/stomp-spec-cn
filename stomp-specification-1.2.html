<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML Basic 1.1//EN" "http://www.w3.org/TR/xhtml-basic/xhtml-basic11.dtd"> 
<!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  Architecture
-->
<html lang="cn">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <meta content="The Simple Text Oriented Messaging Protocol" name="description"/>
    <meta content="stomp,messaging,mom,middleware,specification" name="keywords"/>
    <meta content="STOMP Specification" name="author"/>
    <link type="text/css" rel="stylesheet" href="styles/impact/css/site.css"/>
    <title>STOMP 协议规范 - 1.2 版</title>
  </head>
  <body>
    <div id="navigation">
      <div class="wrapper">
<ul>
  <li><a href="index.html">STOMP</a></li>
  <li><a href="stomp-specification-1.2.html">1.2</a></li>
  <li><a href="implementations.html">实现</a></li>
  <li><a target="_blank" href="https://github.com/Yue-plus/stomp-spec-cn">GitHub</a></li>
</ul>        <div></div>
      </div>
    </div>
    <div id="content">
      <div class="wrapper">
<h1 id = "STOMP_Protocol_Specification__Version_1_2">STOMP 协议规范 - 1.2 版</h1>

<p><div class="toc"><ul style="list-style:none;">
  <li><a href="#Abstract">概要</a></li>
  <li><a href="#Overview">总览</a></li>
  <li><ul style="list-style:none;">
    <li><a href="#Background">背景</a></li>
    <li><a href="#Protocol_Overview">协议总览</a></li>
    <li><a href="#Changes_in_the_Protocol">协议的变化</a></li>
    <li><a href="#Design_Philosophy">设计理念</a></li>
  </ul></li>
  <li><a href="#Conformance">一致性</a></li>
  <li><a href="#STOMP_Frames">STOMP 帧</a></li>
  <li><ul style="list-style:none;">
    <li><a href="#Value_Encoding">值编码</a></li>
    <li><a href="#Body">正文</a></li>
    <li><a href="#Standard_Headers">标准标头</a></li>
    <li><ul style="list-style:none;">
      <li><a href="#Header_content-length">标头 <code>content-length</code></a></li>
      <li><a href="#Header_content-type">Header content-type</a></li>
      <li><a href="#Header_receipt">Header receipt</a></li>
    </ul></li>
    <li><a href="#Repeated_Header_Entries">Repeated Header Entries</a></li>
    <li><a href="#Size_Limits">Size Limits</a></li>
    <li><a href="#Connection_Lingering">Connection Lingering</a></li>
  </ul></li>
  <li><a href="#Connecting">Connecting</a></li>
  <li><ul style="list-style:none;">
    <li><a href="#CONNECT_or_STOMP_Frame">CONNECT or STOMP Frame</a></li>
    <li><a href="#CONNECTED_Frame">CONNECTED Frame</a></li>
    <li><a href="#Protocol_Negotiation">Protocol Negotiation</a></li>
    <li><a href="#Heart-beating">Heart-beating</a></li>
  </ul></li>
  <li><a href="#Client_Frames">Client Frames</a></li>
  <li><ul style="list-style:none;">
    <li><a href="#SEND">SEND</a></li>
    <li><a href="#SUBSCRIBE">SUBSCRIBE</a></li>
    <li><ul style="list-style:none;">
      <li><a href="#SUBSCRIBE_id_Header">SUBSCRIBE id Header</a></li>
      <li><a href="#SUBSCRIBE_ack_Header">SUBSCRIBE ack Header</a></li>
    </ul></li>
    <li><a href="#UNSUBSCRIBE">UNSUBSCRIBE</a></li>
    <li><a href="#ACK">ACK</a></li>
    <li><a href="#NACK">NACK</a></li>
    <li><a href="#BEGIN">BEGIN</a></li>
    <li><a href="#COMMIT">COMMIT</a></li>
    <li><a href="#ABORT">ABORT</a></li>
    <li><a href="#DISCONNECT">DISCONNECT</a></li>
  </ul></li>
  <li><a href="#Server_Frames">Server Frames</a></li>
  <li><ul style="list-style:none;">
    <li><a href="#MESSAGE">MESSAGE</a></li>
    <li><a href="#RECEIPT">RECEIPT</a></li>
    <li><a href="#ERROR">ERROR</a></li>
  </ul></li>
  <li><a href="#Frames_and_Headers">Frames and Headers</a></li>
  <li><a href="#Augmented_BNF">Augmented BNF</a></li>
  <li><a href="#License">License</a></li>
</ul></div></p>

<h2 id = "Abstract">概要</h2>

<p>STOMP 是一种简单的互操作协议，旨在通过中介服务器在客户端之间传递异步消息。
  它为在这些客户端与服务端之间传递的消息定义了基于文本的连接格式。</p>

<p>STOMP 已活跃使用多年，并得到许多消息代理与客户端库的支持。
  本规范定义了 STOMP 1.2 协议，并且是
  <a href="stomp-specification-1.1.html">STOMP 1.1</a> 的更新。</p>

<p>请将反馈发送到
  <a href="mailto:stomp-spec@googlegroups.com">stomp-spec@googlegroups.com</a>
  邮件列表。</p>

<p>在此感谢所有翻译贡献者：</p>

<ul>
  <li><a target="_blank" href="https://github.com/Yue-plus">Yue-plus</a></li>
</ul>

<p><strong>欢迎补充或改善本站翻译，可以
  <a target="_blank" href="https://github.com/Yue-plus/stomp-spec-cn/issues/new/choose">发送 Issues</a>
  或直接 Fork 本站仓库，并提交拉取请求。</strong></p>

<h2 id = "Overview">总览</h2>

<h3 id = "Background">背景</h3>

<p>STOMP 源于需要通过脚本语言（例如：Ruby、Python 与 Perl）连接到企业消息代理的需求。
  在这种环境中，通常会执行逻辑上简单的操作，
  例如“可靠地发送单个消息并断开连接”或“消费给定目的地上的所有消息”。</p>

<p>它是其他开放消息协议（例如：AMQP）与 JMS 代理（例如：OpenWire）中使用的实现特定连接协议的替代。
  它的独特之处是只涵盖了一小部分常用的消息传递操作，而不是提供一个全面的消息传递 API。</p>

<p>最近，STOMP 已经发展成为一种协议，就其现在提供的线路级特性而言，
  可以通过这些简单的用例使用，但仍保持其简单性和互操作性的核心设计原则。</p>

<h3 id = "Protocol_Overview">协议总览</h3>

<p>STOMP 是基于帧的协议，其帧以 HTTP 为模型。
  框架由命令，一组可选的标头与可选的主体组成。
  STOMP 基于文本，但也允许传输二进制消息。
  STOMP 的默认编码为 UTF-8，但是支持消息体的替代编码规范。</p>

<p>STOMP 服务器被建模为一组可以向其发送消息的目标。
  STOMP 协议将目标视为不透明字符串，并且其语法是服务器实现特定的。
  此外，STOMP 并未定义目的地的传递语义。
  目的地的传递或“消息交换”的语义可能因服务器而异，甚至因目的地而异。
  这使服务器可以利用 STOMP 支持的语义进行创新。</p>

<p>STOMP 客户端是一种用户代理，可以以两种（可能同时）模式运行：</p>

<ul>
<li><p>作为生产者，通过 <code>SEND</code> 帧将消息发送到服务器上的目标</p></li>
<li><p>作为消费者，发送给定目标的 <code>SUBSCRIBE</code> 帧，
  并以 <code>MESSAGE</code> 帧的形式从服务器接收消息。</p></li>
</ul>

<h3 id = "Changes_in_the_Protocol">协议的变化</h3>

<p>STOMP 1.2 在很大程度上向后兼容 STOMP 1.1。
  只有两个不兼容的更改：</p>

<ul>
<li><p>现在可以用回车加换行符来结束帧行，而不是只换行</p></li>
<li><p>消息确认已简化，现在使用专用标头</p></li>
</ul>

<p>除此之外，STOMP 1.2 没有引入任何新特性，而是着重于阐明规范的某些方面，例如：</p>

<ul>
<li><p>重复帧标头项</p></li>
<li><p>使用 <code>content-length</code> 与 <code>content-type</code> 标头</p></li>
<li><p>服务端对 <code>STOMP</code> 帧的必要支持</p></li>
<li><p>连接延迟</p></li>
<li><p>订阅与事务标识符的作用域与唯一性</p></li>
<li><p><code>RECEIPT</code> 帧相对于上一帧的含义</p></li>
</ul>

<h3 id = "Design_Philosophy">设计理念</h3>

<p>驱动 STOMP 设计的主要理念是简单性与互操作性。</p>

<p>STOMP 被设计为一种轻量级协议，易于在客户端和服务器端以多种语言实现。
  特别是，这意味着对服务端的体系结构没有太多限制，
  并且诸如目标命名与可靠性语义之类的许多功能是特定于实现的。</p>

<p>在本规范中，将注意 STOMP 1.2 未明确定义的服务端特性。
  应查阅 STOMP 服务端文档，了解这些特性的具体实现细节。</p>

<h2 id = "Conformance">一致性</h2>

<p>本文档中的关键字：
  <dl>
    <dt><strong>必须</strong>（<code>MUST</code>、<code>REQUIRED</code>、<code>SHALL</code>）</dt>
    <dd>意味着这是本规范的绝对要求。</dd>
    <dt><strong>绝不</strong>（<code>MUST NOT</code>、<code>SHALL NOT</code>）</dt>
    <dd>意味着这是本规范的绝对禁止。</dd>
    <dt><strong>应该</strong>、<strong>建议</strong>（<code>SHOULD</code>、<code>RECOMMENDED</code>）</dt>
    <dd>表示在特定情况下可能存在忽略特定项目的正当理由，但是在选择不同的路线之前，必须理解并仔细权衡所有含义。</dd>
    <dt><strong>不该</strong>（<code>SHOULD NOT</code>）</dt>
    <dd>这意味着在特定情况下，当特定的行为是可接受的甚至是有用的时，可能存在正当理由，
      但在实施带有此标签描述的任何行为之前，应了解其全部含义并仔细权衡该案例。</dd>
    <dt><strong>可以</strong>、<strong>可选</strong>（<code>MAY</code>、<code>OPTIONAL</code>）</dt>
    <dd>表示某项是真正可选的。<br />
      一个供应商可能选择包括该项目，因为某个特定的市场需要它，或者因为该供应商认为它增强了产品，而另一个供应商可能会忽略该产品。<br />
      一个不包含特定选项的实现 <strong>必须</strong> 准备与另一个包含该选项的实现互操作，尽管功能可能有所减少。<br />
      同样，一个确实包含特定选项的实现 <strong>必须</strong> 准备与另一个不包含该选项的实现互操作
      （当然，该选项所提供的功能除外）。</dd>
  </dl>
  按照 <a href="http://tools.ietf.org/html/rfc2119">RFC 2119</a> 中所述进行解释。</p>

<p>实现可能会对不受约束的输入施加特定于实现的限制，
  例如：防止拒绝服务攻击、防止内存耗尽或绕过特定于平台的限制。</p>

<p>本规范定义的一致性类是 STOMP 客户端与 STOMP 服务端。</p>

<h2 id = "STOMP_Frames">STOMP 帧</h2>

<p>STOMP 是一种基于帧的协议，该协议假定底层具有可靠的双向流网络协议（例如：TCP）。
  客户端与服务端将使用通过流发送的 STOMP 帧进行通信。
  帧的结构看起来就像：</p>

<pre><code>COMMAND
header1:value1
header2:value2

Body^@</code></pre>

<p>帧以一个以行尾（EOL）结束的命令字符串开头，
  该命令字符串由一个 <strong>可选</strong> 的回车符（octet 13）与一个 <strong>必须</strong> 的换行符（octet 10）组成。<br />
  该命令后是零个或多个 <code>&lt;key&gt;</code>:<code>&lt;value&gt;</code> 格式的标头项。<br />
  每个标头项都由 EOL 终止。<br />
  空行（即额外的 EOL）表示标头的结束与正文的开始。<br />
  然后，正文后跟 NULL octet。<br />
  本文档中的示例将使用 ASCII 中的  <code>^@</code>，control-@ 来表示 NULL octet。<br />
  NULL octet 后面可以有多个 EOL。<br />
  有关如何解析 STOMP 帧的更多详细信息，请参见本文档的 <a href="#Augmented&#95;BNF">BNF 增强</a> 部分。</p>

<p>本文档中引用的所有命令与标头名均区分大小写。</p>

<h3 id = "Value_Encoding">值编码</h3>

<p>命令与标头以 UTF-8 编码。
  除 <code>CONNECT</code> 与 <code>CONNECTED</code>
  帧以外的所有帧都将转义在生成的 UTF-8 编码标头中发现的任何回车、换行或冒号。</p>

<p>需要转义以允许标头键与值包含那些帧标头定界 octet 作为值。
  为了保持与 STOMP 1.0 的向后兼容性，
  <code>CONNECT</code> 与 <code>CONNECTED</code> 帧不会对回车、换行或冒号字节进行转义。</p>

<p>C 语言风格的字符串字面转义用于编码任何在 UTF-8 编码的头文件中发现的回车、换行或冒号。
  解码帧标头时，<strong>必须</strong> 应用以下转换：</p>

<ul>
<li><code>\r</code> (octet 92 与 114) 转换为回车 (octet 13)</li>
<li><code>\n</code> (octet 92 与 110) 转换为换行 (octet 10)</li>
<li><code>\c</code> (octet 92 与 99) 转换为 <code>:</code> (octet 58)</li>
<li><code>\\</code> (octet 92 与 92) 转换为 <code>\</code> (octet 92)</li>
</ul>

<p><strong>必须</strong> 将未定义的转义序列（例如 <code>\t</code>(octet 92 与 116)）视为致命协议错误。
  相反，在编码帧标头头时，<strong>必须</strong> 应用反向转换。</p>

<p>STOMP 1.0 规范包含了许多在标头中填充的示例帧，许多服务端与客户端都实现了修剪或填充标头值。
  如果应用程序要发送不应修剪的标头，这会导致问题。
  在 STOMP 1.2 中，客户端与服务端 <strong>必须</strong> 禁止修剪标头或用空格填充标头。</p>

<h3 id = "Body">正文</h3>

<p>只有 <code>SEND</code>、<code>MESSAGE</code> 与 <code>ERROR</code> 帧 <strong> 可以</strong> 有正文。
  所有其他的帧都 <strong>绝不</strong> 能有正文。</p>

<h3 id = "Standard_Headers">标准标头</h3>

<p>对于大多数帧，<strong>可以</strong> 使用某些标头，并具有特殊含义。</p>

<h4 id = "Header_content-length">标头 <code>content-length</code></h4>

<p>所有帧都可以包含一个 <code>content-length</code> 的标头。
  此标头是消息正文长度的 octet 数量。
  如果包含 <code>content-length</code> 标头，那么无论正文中是否存在 NULL octet，都 <strong>必须</strong> 读取此 octet 数字。
  该帧仍然需要以 NULL octet 终止。</p>

<p>如果存在帧正文，那么 <code>SEND</code>、<code>MESSAGE</code> 与 <code>ERROR</code> 帧应包含 <code>content-length</code> 标头，以简化帧解析。
  如果帧正文包含 NULL octet，那么该帧必须包含一个 <code>content-length</code> 标头。</p>

<h4 id = "Header_content-type">Header content-type</h4>

<p>If a frame body is present, the <code>SEND</code>, <code>MESSAGE</code> and <code>ERROR</code> frames SHOULD
include a <code>content-type</code> header to help the receiver of the frame interpret
its body. If the <code>content-type</code> header is set, its value MUST be a MIME type
which describes the format of the body. Otherwise, the receiver SHOULD
consider the body to be a binary blob.</p>

<p>The implied text encoding for MIME types starting with <code>text/</code> is UTF-8. If
you are using a text based MIME type with a different encoding then you
SHOULD append <code>;charset=&lt;encoding&gt;</code> to the MIME type. For example,
<code>text/html;charset=utf-16</code> SHOULD be used if you're sending an HTML body in
UTF-16 encoding. The <code>;charset=&lt;encoding&gt;</code> SHOULD also get appended to any
non <code>text/</code> MIME types which can be interpreted as text. A good example of
this would be a UTF-8 encoded XML. Its <code>content-type</code> SHOULD get set to
<code>application/xml;charset=utf-8</code></p>

<p>All STOMP clients and servers MUST support UTF-8 encoding and decoding. Therefore,
for maximum interoperability in a heterogeneous computing environment, it is
RECOMMENDED that text based content be encoded with UTF-8.</p>

<h4 id = "Header_receipt">Header receipt</h4>

<p>Any client frame other than <code>CONNECT</code> MAY specify a <code>receipt</code> header with an
arbitrary value. This will cause the server to acknowledge the processing of
the client frame with a <code>RECEIPT</code> frame (see the <a href="#RECEIPT">RECEIPT</a> frame
for more details).</p>

<pre><code>SEND
destination:/queue/a
receipt:message-12345

hello queue a^@</code></pre>

<h3 id = "Repeated_Header_Entries">Repeated Header Entries</h3>

<p>Since messaging systems can be organized in store and forward topologies,
similar to SMTP, a message may traverse several messaging servers before
reaching a consumer. A STOMP server MAY 'update' header values by either
prepending headers to the message or modifying a header in-place in the
message.</p>

<p>If a client or a server receives repeated frame header entries, only the
first header entry SHOULD be used as the value of header entry. Subsequent
values are only used to maintain a history of state changes of the header
and MAY be ignored.</p>

<p>For example, if the client receives:</p>

<pre><code>MESSAGE
foo:World
foo:Hello

^@</code></pre>

<p>The value of the <code>foo</code> header is just <code>World</code>.</p>

<h3 id = "Size_Limits">Size Limits</h3>

<p>To prevent malicious clients from exploiting memory allocation in a
server, servers MAY place maximum limits on:</p>

<ul>
<li>the number of frame headers allowed in a single frame</li>
<li>the maximum length of header lines</li>
<li>the maximum size of a frame body</li>
</ul>

<p>If these limits are exceeded the server SHOULD send the client an <code>ERROR</code>
frame and then close the connection.</p>

<h3 id = "Connection_Lingering">Connection Lingering</h3>

<p>STOMP servers must be able to support clients which rapidly connect and
disconnect.</p>

<p>This implies a server will likely only allow closed connections to linger
for short time before the connection is reset.</p>

<p>As a consequence, a client may not receive the last frame sent by the server
(for instance an <code>ERROR</code> frame or the <code>RECEIPT</code> frame in reply to a
<code>DISCONNECT</code> frame) before the socket is reset.</p>

<h2 id = "Connecting">Connecting</h2>

<p>A STOMP client initiates the stream or TCP connection to the server by sending
the <code>CONNECT</code> frame:</p>

<pre><code>CONNECT
accept-version:1.2
host:stomp.github.org

^@</code></pre>

<p>If the server accepts the connection attempt it will respond with a
<code>CONNECTED</code> frame:</p>

<pre><code>CONNECTED
version:1.2

^@</code></pre>

<p>The server can reject any connection attempt. The server SHOULD respond back
with an <code>ERROR</code> frame explaining why the connection was rejected and then close
the connection.</p>

<h3 id = "CONNECT_or_STOMP_Frame">CONNECT or STOMP Frame</h3>

<p>STOMP servers MUST handle a <code>STOMP</code> frame in the same manner as a <code>CONNECT</code>
frame. STOMP 1.2 clients SHOULD continue to use the <code>CONNECT</code> command to
remain backward compatible with STOMP 1.0 servers.</p>

<p>Clients that use the <code>STOMP</code> frame instead of the <code>CONNECT</code> frame will only
be able to connect to STOMP 1.2 servers (as well as some STOMP 1.1 servers)
but the advantage is that a protocol sniffer/discriminator will be able to
differentiate the STOMP connection from an HTTP connection.</p>

<p>STOMP 1.2 clients MUST set the following headers:</p>

<ul>
<li><p><code>accept-version</code> : The versions of the STOMP protocol the client supports.
See <a href="#Protocol&#95;Negotiation">Protocol Negotiation</a> for more details.</p></li>
<li><p><code>host</code> : The name of a virtual host that the client wishes to connect to.
It is recommended clients set this to the host name that the socket
was established against, or to any name of their choosing. If this
header does not match a known virtual host, servers supporting virtual
hosting MAY select a default virtual host or reject the connection.</p></li>
</ul>

<p>STOMP 1.2 clients MAY set the following headers:</p>

<ul>
<li><p><code>login</code> : The user identifier used to authenticate against a secured STOMP server.</p></li>
<li><p><code>passcode</code> : The password used to authenticate against a secured STOMP
server.</p></li>
<li><p><code>heart-beat</code> : The <a href="#Heart-beating">Heart-beating</a> settings.</p></li>
</ul>

<h3 id = "CONNECTED_Frame">CONNECTED Frame</h3>

<p>STOMP 1.2 servers MUST set the following headers:</p>

<ul>
<li><code>version</code> : The version of the STOMP protocol the session will be using.
See <a href="#Protocol&#95;Negotiation">Protocol Negotiation</a> for more details.</li>
</ul>

<p>STOMP 1.2 servers MAY set the following headers:</p>

<ul>
<li><p><code>heart-beat</code> : The <a href="#Heart-beating">Heart-beating</a> settings.</p></li>
<li><p><code>session</code> : A session identifier that uniquely identifies the session.</p></li>
<li><p><code>server</code> : A field that contains information about the STOMP server.
The field MUST contain a server-name field and MAY be followed by optional 
comment fields delimited by a space character.</p>

<p>The server-name field consists of a name token followed by an optional version
number token.</p>

<p><code>server      = name ["/" version] *(comment)</code></p>

<p>Example:</p>

<p><code>server:Apache/1.3.9</code></p></li>
</ul>

<h3 id = "Protocol_Negotiation">Protocol Negotiation</h3>

<p>From STOMP 1.1 and onwards, the <code>CONNECT</code> frame MUST include the
<code>accept-version</code> header. It SHOULD be set to a comma separated list of
incrementing STOMP protocol versions that the client supports. If the
<code>accept-version</code> header is missing, it means that the client only supports
version 1.0 of the protocol.</p>

<p>The protocol that will be used for the rest of the session will be the
highest protocol version that both the client and server have in common.</p>

<p>For example, if the client sends:</p>

<pre><code>CONNECT
accept-version:1.0,1.1,2.0
host:stomp.github.org

^@</code></pre>

<p>The server will respond back with the highest version of the protocol that
it has in common with the client:</p>

<pre><code>CONNECTED
version:1.1

^@</code></pre>

<p>If the client and server do not share any common protocol versions, then the
server MUST respond with an <code>ERROR</code> frame similar to the following and then
close the connection:</p>

<pre><code>ERROR
version:1.2,2.1
content-type:text/plain

Supported protocol versions are 1.2 2.1^@</code></pre>

<h3 id = "Heart-beating">Heart-beating</h3>

<p>Heart-beating can optionally be used to test the healthiness of the
underlying TCP connection and to make sure that the remote end is alive and
kicking.</p>

<p>In order to enable heart-beating, each party has to declare what it can do
and what it would like the other party to do. This happens at the very
beginning of the STOMP session, by adding a <code>heart-beat</code> header to the
<code>CONNECT</code> and <code>CONNECTED</code> frames.</p>

<p>When used, the <code>heart-beat</code> header MUST contain two positive integers
separated by a comma.</p>

<p>The first number represents what the sender of the frame can do (outgoing
heart-beats):</p>

<ul>
<li><p>0 means it cannot send heart-beats</p></li>
<li><p>otherwise it is the smallest number of milliseconds between heart-beats
that it can guarantee</p></li>
</ul>

<p>The second number represents what the sender of the frame would like
to get (incoming heart-beats):</p>

<ul>
<li><p>0 means it does not want to receive heart-beats</p></li>
<li><p>otherwise it is the desired number of milliseconds between heart-beats</p></li>
</ul>

<p>The <code>heart-beat</code> header is OPTIONAL. A missing <code>heart-beat</code> header MUST be
treated the same way as a &ldquo;heart-beat:0,0&rdquo; header, that is: the party cannot
send and does not want to receive heart-beats.</p>

<p>The <code>heart-beat</code> header provides enough information so that each party can
find out if heart-beats can be used, in which direction, and with which
frequency.</p>

<p>More formally, the initial frames look like:</p>

<pre><code>CONNECT
heart-beat:&lt;cx&gt;,&lt;cy&gt;

CONNECTED
heart-beat:&lt;sx&gt;,&lt;sy&gt;</code></pre>

<p>For heart-beats from the client to the server:</p>

<ul>
<li><p>if <code>&lt;cx&gt;</code> is 0 (the client cannot send heart-beats) or <code>&lt;sy&gt;</code> is 0 (the
server does not want to receive heart-beats) then there will be none</p></li>
<li><p>otherwise, there will be heart-beats every MAX(<code>&lt;cx&gt;</code>,<code>&lt;sy&gt;</code>) milliseconds</p></li>
</ul>

<p>In the other direction, <code>&lt;sx&gt;</code> and <code>&lt;cy&gt;</code> are used the same way.</p>

<p>Regarding the heart-beats themselves, any new data received over the network
connection is an indication that the remote end is alive. In a given
direction, if heart-beats are expected every <code>&lt;n&gt;</code> milliseconds:</p>

<ul>
<li><p>the sender MUST send new data over the network connection at least every
<code>&lt;n&gt;</code> milliseconds</p></li>
<li><p>if the sender has no real STOMP frame to send, it MUST send an end-of-line (EOL)</p></li>
<li><p>if, inside a time window of at least <code>&lt;n&gt;</code> milliseconds, the receiver did
not receive any new data, it MAY consider the connection as dead</p></li>
<li><p>because of timing inaccuracies, the receiver SHOULD be tolerant and take
into account an error margin</p></li>
</ul>

<h2 id = "Client_Frames">Client Frames</h2>

<p>A client MAY send a frame not in this list, but for such a frame a STOMP 1.2
server MAY respond with an <code>ERROR</code> frame and then close the connection.</p>

<ul>
<li><a href="#SEND"><code>SEND</code></a></li>
<li><a href="#SUBSCRIBE"><code>SUBSCRIBE</code></a></li>
<li><a href="#UNSUBSCRIBE"><code>UNSUBSCRIBE</code></a></li>
<li><a href="#BEGIN"><code>BEGIN</code></a></li>
<li><a href="#COMMIT"><code>COMMIT</code></a></li>
<li><a href="#ABORT"><code>ABORT</code></a></li>
<li><a href="#ACK"><code>ACK</code></a></li>
<li><a href="#NACK"><code>NACK</code></a></li>
<li><a href="#DISCONNECT"><code>DISCONNECT</code></a></li>
</ul>

<h3 id = "SEND">SEND</h3>

<p>The <code>SEND</code> frame sends a message to a destination in the messaging system. It
has one REQUIRED header, <code>destination</code>, which indicates where to send the
message. The body of the <code>SEND</code> frame is the message to be sent. For example:</p>

<pre><code>SEND
destination:/queue/a
content-type:text/plain

hello queue a
^@</code></pre>

<p>This sends a message to a destination named <code>/queue/a</code>. Note that STOMP treats
this destination as an opaque string and no delivery semantics are assumed by
the name of a destination. You should consult your STOMP server's
documentation to find out how to construct a destination name which gives you
the delivery semantics that your application needs.</p>

<p>The reliability semantics of the message are also server specific and will
depend on the destination value being used and the other message headers
such as the <code>transaction</code> header or other server specific message headers.</p>

<p><code>SEND</code> supports a <code>transaction</code> header which allows for transactional sends.</p>

<p><code>SEND</code> frames SHOULD include a
<a href="#Header&#95;content-length"><code>content-length</code></a> header and a
<a href="#Header&#95;content-type"><code>content-type</code></a> header if a body is present.</p>

<p>An application MAY add any arbitrary user defined headers to the <code>SEND</code> frame.
User defined headers are typically used to allow consumers to filter
messages based on the application defined headers using a selector
on a <code>SUBSCRIBE</code> frame. The user defined headers MUST be passed through
in the <code>MESSAGE</code> frame.</p>

<p>If the server cannot successfully process the <code>SEND</code> frame for any reason,
the server MUST send the client an <code>ERROR</code> frame and then close the connection.</p>

<h3 id = "SUBSCRIBE">SUBSCRIBE</h3>

<p>The <code>SUBSCRIBE</code> frame is used to register to listen to a given destination.
Like the <code>SEND</code> frame, the <code>SUBSCRIBE</code> frame requires a <code>destination</code> header
indicating the destination to which the client wants to subscribe. Any
messages received on the subscribed destination will henceforth be delivered
as <code>MESSAGE</code> frames from the server to the client. The <code>ack</code> header controls
the message acknowledgment mode.</p>

<p>Example:</p>

<pre><code>SUBSCRIBE
id:0
destination:/queue/foo
ack:client

^@</code></pre>

<p>If the server cannot successfully create the subscription,
the server MUST send the client an <code>ERROR</code> frame and then close the connection.</p>

<p>STOMP servers MAY support additional server specific headers to customize the
delivery semantics of the subscription. Consult your server's documentation for
details.</p>

<h4 id = "SUBSCRIBE_id_Header">SUBSCRIBE id Header</h4>

<p>Since a single connection can have multiple open subscriptions with a
server, an <code>id</code> header MUST be included in the frame to uniquely identify
the subscription. The <code>id</code> header allows the client and server to relate
subsequent <code>MESSAGE</code> or <code>UNSUBSCRIBE</code> frames to the original subscription.</p>

<p>Within the same connection, different subscriptions MUST use different
subscription identifiers.</p>

<h4 id = "SUBSCRIBE_ack_Header">SUBSCRIBE ack Header</h4>

<p>The valid values for the <code>ack</code> header are <code>auto</code>, <code>client</code>, or
<code>client-individual</code>. If the header is not set, it defaults to <code>auto</code>.</p>

<p>When the <code>ack</code> mode is <code>auto</code>, then the client does not need to send the
server <code>ACK</code> frames for the messages it receives. The server will assume the
client has received the message as soon as it sends it to the client.
This acknowledgment mode can cause messages being transmitted to the client
to get dropped.</p>

<p>When the <code>ack</code> mode is <code>client</code>, then the client MUST send the server
<code>ACK</code> frames for the messages it processes. If the connection fails before a
client sends an <code>ACK</code> frame for the message the server will assume the message
has not been processed and MAY redeliver the message to another client. The
<code>ACK</code> frames sent by the client will be treated as a cumulative acknowledgment.
This means the acknowledgment operates on the message specified in the <code>ACK</code>
frame and all messages sent to the subscription before the <code>ACK</code>'ed message.</p>

<p>In case the client did not process some messages, it SHOULD send <code>NACK</code> frames
to tell the server it did not consume these messages.</p>

<p>When the <code>ack</code> mode is <code>client-individual</code>, the acknowledgment operates just
like the <code>client</code> acknowledgment mode except that the <code>ACK</code> or <code>NACK</code> frames
sent by the client are not cumulative. This means that an <code>ACK</code> or <code>NACK</code>
frame for a subsequent message MUST NOT cause a previous message to get
acknowledged.</p>

<h3 id = "UNSUBSCRIBE">UNSUBSCRIBE</h3>

<p>The <code>UNSUBSCRIBE</code> frame is used to remove an existing subscription. Once the
subscription is removed the STOMP connections will no longer receive messages
from that subscription.</p>

<p>Since a single connection can have multiple open subscriptions with a
server, an <code>id</code> header MUST be included in the frame to uniquely identify
the subscription to remove. This header MUST match the subscription
identifier of an existing subscription.</p>

<p>Example:</p>

<pre><code>UNSUBSCRIBE
id:0

^@</code></pre>

<h3 id = "ACK">ACK</h3>

<p><code>ACK</code> is used to acknowledge consumption of a message from a subscription
using <code>client</code> or <code>client-individual</code> acknowledgment. Any messages received
from such a subscription will not be considered to have been consumed until
the message has been acknowledged via an <code>ACK</code>.</p>

<p>The <code>ACK</code> frame MUST include an <code>id</code> header matching the <code>ack</code> header of the
<code>MESSAGE</code> being acknowledged. Optionally, a <code>transaction</code> header MAY be
specified, indicating that the message acknowledgment SHOULD be part of the
named transaction.</p>

<pre><code>ACK
id:12345
transaction:tx1

^@</code></pre>

<h3 id = "NACK">NACK</h3>

<p><code>NACK</code> is the opposite of <code>ACK</code>. It is used to tell the server that the
client did not consume the message. The server can then either send the
message to a different client, discard it, or put it in a dead letter queue.
The exact behavior is server specific.</p>

<p><code>NACK</code> takes the same headers as <code>ACK</code>: <code>id</code> (REQUIRED) and <code>transaction</code>
(OPTIONAL).</p>

<p><code>NACK</code> applies either to one single message (if the subscription's <code>ack</code>
mode is <code>client-individual</code>) or to all messages sent before and not yet
<code>ACK</code>'ed or <code>NACK</code>'ed (if the subscription's <code>ack</code> mode is <code>client</code>).</p>

<h3 id = "BEGIN">BEGIN</h3>

<p><code>BEGIN</code> is used to start a transaction. Transactions in this case apply to
sending and acknowledging - any messages sent or acknowledged during a
transaction will be processed atomically based on the transaction.</p>

<pre><code>BEGIN
transaction:tx1

^@</code></pre>

<p>The <code>transaction</code> header is REQUIRED, and the transaction identifier will be
used for <code>SEND</code>, <code>COMMIT</code>, <code>ABORT</code>, <code>ACK</code>, and <code>NACK</code> frames to bind them to
the named transaction. Within the same connection, different transactions MUST
use different transaction identifiers.</p>

<p>Any started transactions which have not been committed will be implicitly
aborted if the client sends a <code>DISCONNECT</code> frame or if the TCP connection
fails for any reason.</p>

<h3 id = "COMMIT">COMMIT</h3>

<p><code>COMMIT</code> is used to commit a transaction in progress.</p>

<pre><code>COMMIT
transaction:tx1

^@</code></pre>

<p>The <code>transaction</code> header is REQUIRED and MUST specify the identifier of the
transaction to commit.</p>

<h3 id = "ABORT">ABORT</h3>

<p><code>ABORT</code> is used to roll back a transaction in progress.</p>

<pre><code>ABORT
transaction:tx1

^@</code></pre>

<p>The <code>transaction</code> header is REQUIRED and MUST specify the identifier of the
transaction to abort.</p>

<h3 id = "DISCONNECT">DISCONNECT</h3>

<p>A client can disconnect from the server at anytime by closing the socket but
there is no guarantee that the previously sent frames have been received by
the server. To do a graceful shutdown, where the client is assured that all
previous frames have been received by the server, the client SHOULD:</p>

<ol>
<li><p>send a <code>DISCONNECT</code> frame with a <code>receipt</code> header set. Example:</p>

<pre><code>DISCONNECT
receipt:77
^@</code></pre></li>
<li><p>wait for the <code>RECEIPT</code> frame response to the <code>DISCONNECT</code>. Example:</p>

<pre><code>RECEIPT
receipt-id:77
^@</code></pre></li>
<li><p>close the socket.</p></li>
</ol>

<p>Note that, if the server closes its end of the socket too quickly, the
client might never receive the expected <code>RECEIPT</code> frame. See the
<a href="#Connection&#95;Lingering">Connection Lingering</a> section for more information.</p>

<p>Clients MUST NOT send any more frames after the <code>DISCONNECT</code> frame is sent.</p>

<h2 id = "Server_Frames">Server Frames</h2>

<p>The server will, on occasion, send frames to the client (in addition to the
initial <code>CONNECTED</code> frame). These frames MAY be one of:</p>

<ul>
<li><a href="#MESSAGE"><code>MESSAGE</code></a></li>
<li><a href="#RECEIPT"><code>RECEIPT</code></a></li>
<li><a href="#ERROR"><code>ERROR</code></a></li>
</ul>

<h3 id = "MESSAGE">MESSAGE</h3>

<p><code>MESSAGE</code> frames are used to convey messages from subscriptions to the client.</p>

<p>The <code>MESSAGE</code> frame MUST include a <code>destination</code> header indicating the
destination the message was sent to. If the message has been sent using
STOMP, this <code>destination</code> header SHOULD be identical to the one used in the
corresponding <code>SEND</code> frame.</p>

<p>The <code>MESSAGE</code> frame MUST also contain a <code>message-id</code> header with a unique
identifier for that message and a <code>subscription</code> header matching the
identifier of the subscription that is receiving the message.</p>

<p>If the message is received from a subscription that requires explicit
acknowledgment (either <code>client</code> or <code>client-individual</code> mode) then the
<code>MESSAGE</code> frame MUST also contain an <code>ack</code> header with an arbitrary
value. This header will be used to relate the message to a subsequent
<code>ACK</code> or <code>NACK</code> frame.</p>

<p>The frame body contains the contents of the message:</p>

<pre><code>MESSAGE
subscription:0
message-id:007
destination:/queue/a
content-type:text/plain

hello queue a^@</code></pre>

<p><code>MESSAGE</code> frames SHOULD include a
<a href="#Header&#95;content-length"><code>content-length</code></a> header and a
<a href="#Header&#95;content-type"><code>content-type</code></a> header if a body is present.</p>

<p><code>MESSAGE</code> frames will also include all user defined headers that were present
when the message was sent to the destination in addition to the server
specific headers that MAY get added to the frame. Consult your server's
documentation to find out the server specific headers that it adds to
messages.</p>

<h3 id = "RECEIPT">RECEIPT</h3>

<p>A <code>RECEIPT</code> frame is sent from the server to the client once a server has
successfully processed a client frame that requests a receipt. A <code>RECEIPT</code>
frame MUST include the header <code>receipt-id</code>, where the value is the value of
the <code>receipt</code> header in the frame which this is a receipt for.</p>

<pre><code>RECEIPT
receipt-id:message-12345

^@</code></pre>

<p>A <code>RECEIPT</code> frame is an acknowledgment that the corresponding client frame
has been <em>processed</em> by the server. Since STOMP is stream based, the receipt
is also a cumulative acknowledgment that all the previous frames have been
<em>received</em> by the server. However, these previous frames may not yet be
fully <em>processed</em>. If the client disconnects, previously received frames
SHOULD continue to get processed by the server.</p>

<h3 id = "ERROR">ERROR</h3>

<p>The server MAY send <code>ERROR</code> frames if something goes wrong. In this case, it
MUST then close the connection just after sending the <code>ERROR</code> frame. See the
next section about <a href="#Connection&#95;Lingering">connection lingering</a>.</p>

<p>The <code>ERROR</code> frame SHOULD contain a <code>message</code> header with a short description
of the error, and the body MAY contain more detailed information (or MAY be
empty).</p>

<pre><code>ERROR
receipt-id:message-12345
content-type:text/plain
content-length:171
message:malformed frame received

The message:
-----
MESSAGE
destined:/queue/a
receipt:message-12345

Hello queue a!
-----
Did not contain a destination header, which is REQUIRED
for message propagation.
^@</code></pre>

<p>If the error is related to a specific frame sent from the client, the server
SHOULD add additional headers to help identify the original frame that caused
the error. For example, if the frame included a receipt header, the <code>ERROR</code>
frame SHOULD set the <code>receipt-id</code> header to match the value of the <code>receipt</code>
header of the frame which the error is related to.</p>

<p><code>ERROR</code> frames SHOULD include a
<a href="#Header&#95;content-length"><code>content-length</code></a> header and a
<a href="#Header&#95;content-type"><code>content-type</code></a> header if a body is present.</p>

<h2 id = "Frames_and_Headers">Frames and Headers</h2>

<p>In addition to the <a href="#Standard&#95;Headers">standard headers</a> described above
(<code>content-length</code>, <code>content-type</code> and <code>receipt</code>), here are all the headers
defined in this specification that each frame MUST or MAY use:</p>

<ul>
<li><code>CONNECT</code> or <code>STOMP</code>
<ul>
<li>REQUIRED: <code>accept-version</code>, <code>host</code></li>
<li>OPTIONAL: <code>login</code>, <code>passcode</code>, <code>heart-beat</code></li>
</ul></li>
<li><code>CONNECTED</code>
<ul>
<li>REQUIRED: <code>version</code></li>
<li>OPTIONAL: <code>session</code>, <code>server</code>, <code>heart-beat</code></li>
</ul></li>
<li><code>SEND</code>
<ul>
<li>REQUIRED: <code>destination</code></li>
<li>OPTIONAL: <code>transaction</code></li>
</ul></li>
<li><code>SUBSCRIBE</code>
<ul>
<li>REQUIRED: <code>destination</code>, <code>id</code></li>
<li>OPTIONAL: <code>ack</code></li>
</ul></li>
<li><code>UNSUBSCRIBE</code>
<ul>
<li>REQUIRED: <code>id</code></li>
<li>OPTIONAL: none</li>
</ul></li>
<li><code>ACK</code> or <code>NACK</code>
<ul>
<li>REQUIRED: <code>id</code></li>
<li>OPTIONAL: <code>transaction</code></li>
</ul></li>
<li><code>BEGIN</code> or <code>COMMIT</code> or <code>ABORT</code>
<ul>
<li>REQUIRED: <code>transaction</code></li>
<li>OPTIONAL: none</li>
</ul></li>
<li><code>DISCONNECT</code>
<ul>
<li>REQUIRED: none</li>
<li>OPTIONAL: <code>receipt</code></li>
</ul></li>
<li><code>MESSAGE</code>
<ul>
<li>REQUIRED: <code>destination</code>, <code>message-id</code>, <code>subscription</code></li>
<li>OPTIONAL: <code>ack</code></li>
</ul></li>
<li><code>RECEIPT</code>
<ul>
<li>REQUIRED: <code>receipt-id</code></li>
<li>OPTIONAL: none</li>
</ul></li>
<li><code>ERROR</code>
<ul>
<li>REQUIRED: none</li>
<li>OPTIONAL: <code>message</code></li>
</ul></li>
</ul>

<p>In addition, the <code>SEND</code> and <code>MESSAGE</code> frames MAY include arbitrary user
defined headers that SHOULD be considered as being part of the carried
message. Also, the <code>ERROR</code> frame SHOULD include additional headers to help
identify the original frame that caused the error.</p>

<p>Finally, STOMP servers MAY use additional headers to give access to features
like persistency or expiration. Consult your server's documentation for
details.</p>

<h2 id = "Augmented_BNF">Augmented BNF</h2>

<p>A STOMP session can be more formally described using the
Backus-Naur Form (BNF) grammar used in HTTP/1.1
<a href="http://tools.ietf.org/html/rfc2616#section-2.1">RFC 2616</a>.</p>

<pre><code>NULL                = &lt;US-ASCII null (octet 0)&gt;
LF                  = &lt;US-ASCII line feed (aka newline) (octet 10)&gt;
CR                  = &lt;US-ASCII carriage return (octet 13)&gt;
EOL                 = [CR] LF 
OCTET               = &lt;any 8-bit sequence of data&gt;

frame-stream        = 1*frame

frame               = command EOL
                      *( header EOL )
                      EOL
                      *OCTET
                      NULL
                      *( EOL )

command             = client-command | server-command

client-command      = "SEND"
                      | "SUBSCRIBE"
                      | "UNSUBSCRIBE"
                      | "BEGIN"
                      | "COMMIT"
                      | "ABORT"
                      | "ACK"
                      | "NACK"
                      | "DISCONNECT"
                      | "CONNECT"
                      | "STOMP"

server-command      = "CONNECTED"
                      | "MESSAGE"
                      | "RECEIPT"
                      | "ERROR"

header              = header-name ":" header-value
header-name         = 1*&lt;any OCTET except CR or LF or ":"&gt;
header-value        = *&lt;any OCTET except CR or LF or ":"&gt;</code></pre>

<h2 id = "License">License</h2>

<p>This specification is licensed under the
<a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution v3.0</a>
license.</p>
        <div></div>
      </div>
    </div>
  </body>
</html>
